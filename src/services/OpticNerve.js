const https = require('https');
const { GoogleGenerativeAI } = require('@google/generative-ai');

// ============================================================
// ğŸ‘ï¸ OpticNerve (è¦–ç¥ç¶“ - Gemini 2.5 Flash Bridge)
// ============================================================
class OpticNerve {
    static async analyze(fileUrl, mimeType, apiKey) {
        console.log(`ğŸ‘ï¸ [OpticNerve] æ­£åœ¨é€é Gemini 2.5 Flash åˆ†ææª”æ¡ˆ (${mimeType})...`);
        try {
            const buffer = await new Promise((resolve, reject) => {
                https.get(fileUrl, (res) => {
                    const data = [];
                    res.on('data', (chunk) => data.push(chunk));
                    res.on('end', () => resolve(Buffer.concat(data)));
                    res.on('error', reject);
                });
            });
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
            const prompt = mimeType.startsWith('image/')
                ? "è«‹è©³ç´°æè¿°é€™å¼µåœ–ç‰‡çš„è¦–è¦ºå…§å®¹ã€‚å¦‚æœåŒ…å«æ–‡å­—æˆ–ç¨‹å¼ç¢¼ï¼Œè«‹å®Œæ•´è½‰éŒ„ã€‚å¦‚æœæ˜¯ä»‹é¢æˆªåœ–ï¼Œè«‹æè¿°UIå…ƒä»¶ã€‚è«‹å¿½ç•¥ç„¡é—œçš„èƒŒæ™¯é›œè¨Šã€‚"
                : "è«‹é–±è®€é€™ä»½æ–‡ä»¶ï¼Œä¸¦æä¾›è©³ç´°çš„æ‘˜è¦ã€é—œéµæ•¸æ“šèˆ‡æ ¸å¿ƒå…§å®¹ã€‚";

            const result = await model.generateContent([
                prompt,
                { inlineData: { data: buffer.toString('base64'), mimeType: mimeType } }
            ]);
            const text = result.response.text();
            console.log("âœ… [OpticNerve] åˆ†æå®Œæˆ (é•·åº¦: " + text.length + ")");
            return text;
        } catch (e) {
            console.error("âŒ [OpticNerve] è§£æå¤±æ•—:", e.message);
            return `(ç³»çµ±éŒ¯èª¤ï¼šè¦–ç¥ç¶“ç„¡æ³•è§£ææ­¤æª”æ¡ˆã€‚åŸå› ï¼š${e.message})`;
        }
    }
}

module.exports = OpticNerve;
